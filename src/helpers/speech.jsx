import axios from "axios";
const referencia =
  "A veces no sabemos cómo nuestras palabras pueden influir tanto en los demás como en nosotros mismos. Hola, mi nombre es Rebeca Schürenkämper, lo dijeron bien, y pues les quiero platicar algo que es muy importante para mí, que aprendí. Hasta hace poco yo pensaba que no era una persona inteligente. Todos los años desde que era chica me creí esta idea y diario me hacía estas preguntas: ¿Soy capaz? ¿Podré? Ellos, ¿qué harán? ¿Ellos cambiarán al mundo? Pero la verdad es que yo también quería cambiar el mundo. Quiero dejar mi marca en algún lugar. Y ¿cómo lo iba a hacer si mis profesores me hicieron creer que no era capaz y que lo que quería hacer no era relevante? Incluso mis compañeros me lo llegan a decir en algún momento y la verdad es que no los culpo, pues es lo que nos enseñaron desde que éramos chicos. Y yo sé que esto era porque no fui la mejor en algunas materias. Pero también sé que fui muy buena en algunas otras. Solo que ellos no lo notaban. Ellos iban a cambiar al mundo. Ya ni siquiera lo preguntaba, lo afirmaba. Eran tantas las palabras que me iban a decir que me las creí y me las puse. Y por eso no estudié lo que realmente quería estudiar. Nada en contra del diseño - me encanta, amo pintar. Pero en ese momento no me creía capaz de hacer lo que puedo hacer ahora. Y no sé si ustedes sabían que el 80 % de los estudiantes en México no saben qué estudiar cuando terminan el colegio. Y claro, ¡cómo no! Cuántas veces escuchamos que alguien dice: “ay, es que mi papá quiere que estudie una carrera real”, ¿no?, como haciendo menos las carreras artísticas, incluso amigos, compañeros, etiquetando carreras como si fueran fáciles. Y si son fáciles es porque no son de personas inteligentes. Incluso etiquetando a las carreras como en un género - ¿cuántas veces no escuchamos que dicen: “esa es una carrera de hombres”? ¿Cómo vas a estudiar ingeniería si eres una mujer? Y viceversa, a los hombres también. Incluso llegamos a comparar las universidades. Como si fuera más importante estudiar en alguna o en otra. Y el 40 % de estos jóvenes en México a la hora de elegir una carrera se equivocan y esto es porque se ven más motivados a lo que los papás les dicen, pero mucho más en los amigos. Y es que esto es porque definimos la inteligencia como una forma de ser, como si tuvieras que tener un aspecto físico adecuado, [como] si te tuvieras que vestirte de una forma adecuada y con una personalidad adecuada, como llenar un papel. Y esto es que nos presiona muchísimo a todos y por eso nos estamos comparando tanto. Por eso comparamos todas las carreras y todo lo que hacemos, porque llegamos a creer que no lo somos, que no somos inteligentes. Pero queremos que los jóvenes sean el futuro - siempre lo decimos, ¿no? Y ¿cómo van a ser el futuro si les hacemos creer que no lo son, cuando ellos realmente son el presente? Ya lo están haciendo. Solo que usamos palabras de rechazo y de fracaso con ellos y se lo creen. Y por eso creen que no son capaces y que no tienen esa inteligencia. Y bueno, ya hablando de esto, ¿qué es inteligencia? Si lo buscan realmente hay muchísimas definiciones de inteligencia. Unos dicen que es entender problemas, razonar, resolverlos, pero la verdad es que no hay una definición exacta de qué es inteligencia.  Sin embargo, el psicólogo Howard Gardner ideó la teoría de las inteligencias múltiples, donde defiende que todas las inteligencias son igual de importantes, que son únicas y diferentes, pero a su manera, y que todas están aquí. Nadie es más inteligente que otro. Simplemente somos distintos. Les voy a dar un ejemplo: hay dos hermanos gemelos, crecen en la misma casa, misma educación, misma escuela, mismos amigos, mismas experiencias, los dos van a tener dos tipos de inteligencia diferentes. Y tal vez fueron a las mismas fiestas, a los mismos eventos, pero tal vez en esa fiesta este gemelo la pasó increíble. Fue el mejor día de su vida, pero este la pasó más o menos, no la disfrutó tanto. Y en ese momento los dos aprendieron algo. Y tal vez lo que este gemelo aprendió, [el otro] lo aprenderá en algún futuro o ya lo aprendió. [O quizás pasará] al revés. El tiempo y el aprendizaje son relativos. Otro ejemplo es que tengas 25 o 30 años. [Eso] no quiere decir que sepas menos que una persona de 80 o de 50 años. Y al revés. Nunca dejamos de aprender, pero creemos que los adultos ya aprendieron todo y por eso frenamos siempre a los jóvenes. Incluso con los papás. Se nos olvida que nuestros papás, abuelos están creciendo y que están aprendiendo todos los días. Prohibimos crecer y nos prohibimos crecer. Con esto de las edades me vienen [a la mente] dos historias: Billie Eilish cuando tenía 17 años ya era una de las cantantes más reconocidas del mundo, de las más importantes, más famosas. Y justo a esa edad estaba nominada a los Grammy y ella rogaba por no ganar, hasta le hacían zoom y ella estaba: “Qué no, (inglés) por favor no! Y eso era porque sabía que la atacarían y estas personas que la atacaban era porque pensaban que no merecía ese reconocimiento - por su edad, porque pensaban que no tenía esa experiencia. Fueron tantas las palabras y tan fuertes que ella se las puso y se las creyó. Pensaba que de verdad no lo merecía, [y no era así]. Otra historia que me viene [a la mente] es de una chics de 26 años, súper buena en lo que hace, súper trabajadora, que tiene aquí todo, tiene toda la experiencia, toda la creatividad del mundo y por fin tuvo la oportunidad de ser jefa. Si sabes que ella tiene como 20 y él tiene 37 [años], él debería de ser nuestro jefe. Uno de los muchos comentarios que llegaron a decir de ella solo por su edad, porque pensaban que no tenía la experiencia cuando en [realidad] lo tenía todo. Con estas dos historias aprendí y entendí algo muy importante: nos da muchísimo miedo, nos aterra pensar que ya no fuimos nosotros y pensamos que nuestro tiempo ya se terminó de cumplir nuestros sueños. Y con sueños no me refiero a ser el más exitoso, el más famoso, el más millonario o el mejor en lo que haces, sino simplemente a hacer algo que nos gusta: estudiar, pintar, tocar, aprender a tocar la guitarra, lo que sea. Pensamos que se terminó. Y es que piénsenlo bien cuando vemos a alguien de 80 años aprendiendo algo y yendo a clases de lo que sea, nos brinca un poquito aunque piensen que no, tal vez algún día se los dijeron o no lo han pensado y cuando lo vean les puede brincar un poco, porque pensamos que esta persona ya debió de haber hecho absolutamente todo y debió de haber aprendido todo. Pero otra vez: el tiempo y el aprendizaje son relativos. Todos aprendemos a diario algo nuevo. Y al revés: vemos a una persona de 19 años súper capaz de hacer todo, de que tiene así un plan de vida, tiene toda la creatividad, tiene todo para poder tener el éxito que se merece, [pero] la frenamos porque creemos que no tiene idea de lo que está haciendo. Nos prohibimos crecer y prohibimos dejar crecer a los demás, en especial a los jóvenes. Nos asusta mucho. Volviendo a la inteligencia, yo en verdad pensaba que no era una persona inteligente. Y lo comprobé una vez en una fiesta, hace mucho [tiempo]. Yo era más chica y estamos jugando un juego que era de señalar todos al mismo tiempo. Estamos en círculo y era por turnos, era de: Ay, ¿quién es la más bonita? y todos señalaban al mismo tiempo, algunos a la misma persona, otros a distintas. La más chistosa, el más fiestero ... Y en un torno una persona dijo: “¿Quién es la más tonta?” Y me señalaron a mí. Todos me señalaron. No hubo ni una sola persona que no me señalara. Y a partir de ese día yo decidí usar esa palabra y olvidé todas mis capacidades. Y sí no estudié lo que quería estudiar. Recuerdo esta historia y me doy cuenta de que fui parte de ese 40 %. Porque me creí esta palabra y porque creí que no era capaz no solo de ellos, sino de muchas personas que conocí. Y hasta hace poco una seguidora me mandó un mensaje donde decía que gracias a mí, gracias a la fundación en la que soy parte, gracias a nuestras palabras, su hermana no se suicidó. Y yo jamás pensé que iba a ser algo así. Salvamos una vida con unas palabras. Salvé una vida. Y yo no me lo creía porque de verdad pensaba que jamás iba a ser capaz de hacer algo. Ese día aprendí muchas cosas, porque llegué a tener una crisis nerviosa, una crisis de ansiedad por no saber mi identidad, y, de repente, todavía me pasa porque siguen usando a veces ese poder conmigo y yo lo permito, en vez de voltearlo y empezar a usar ese poder de mis palabras conmigo. Ese día que me mandaron ese mensaje entendí que yo quería cambiar el mundo sin entender que ya lo estaba haciendo. Que tal vez como joven no iba a ser el futuro en matemáticas, pero sí lo iba a ser con mis palabras. Tal vez no cambiaré el mundo [entero], pero sí cambiaré el mundo de una sola persona. Y ahora estoy aquí con ustedes platicándoles mi experiencia, algo que jamás pensé [hacer], que era un sueño para mí, que jamás pensé que iba a ser capaz. Pero estoy celebrando mi inteligencia con ustedes, junto con la inteligencia de todos ustedes. Porque a eso vinimos al mundo: a compartir nuestra inteligencia, para cambiarlo. Tal vez algunos en ciencia, otros en emociones, otros a través del arte, pero a eso venimos a compartirla. Y ustedes, ¿cómo usan ese poder? ¿Cómo utilizas el poder de tu palabra? Porque como Albert Einstein dijo: “si juzgas a un pez por su habilidad para escalar un árbol, vivirá toda su vida pensando que es un inútil. Gracias";
// Función auxiliar para convertir bytes a megabytes
const bytesToMegabytes = (bytes) => {
  return bytes / (1024 * 1024);
};
// Función auxiliar para convertir un blob de audio
const audioBlobToBase64 = (blob) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const arrayBuffer = reader.result;
      const base64Audio = btoa(
        new Uint8Array(arrayBuffer).reduce(
          (data, byte) => data + String.fromCharCode(byte),
          ""
        )
      );
      resolve(base64Audio);
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(blob);
  });
};

// Función auxiliar para dividir un texto base64 en segmentos
const splitBase64Text = (base64Text) => {
  const segmentSize = 1024 * 1024; // 1MB
  const totalSegments = Math.ceil(base64Text.length / segmentSize);
  const segmentsArray = [];

  for (let i = 0; i < totalSegments; i++) {
    const start = i * segmentSize;
    const end = Math.min(start + segmentSize, base64Text.length);
    const segment = base64Text.substring(start, end);
    segmentsArray.push(segment);
  }

  return segmentsArray;
};

// Función para dividir un texto base64 de audio en segmentos y enviarlos a la API
const splitAndSendSegments = async (base64Text, key, lan) => {
  const segmentSize = 1024 * 1024; // 1MB
  const totalSegments = Math.ceil(base64Text.length / segmentSize);
  const segmentsArray = [];
  // Dividir el texto base64 en segmentos
  for (let i = 0; i < totalSegments; i++) {
    const start = i * segmentSize;
    const end = Math.min(start + segmentSize, base64Text.length);
    const segment = base64Text.substring(start, end);
    segmentsArray.push(segment);
  }

  // Mapear cada segmento a una Promesa para enviarlo a la API
  const promises = splitBase64Text(base64Text).map(async (e, index) => {
    const endpoint = `https://speech.googleapis.com/v1/speech:recognize?key=${key}`;
    return await axios
      .post(endpoint, {
        config: {
          encoding: "MP3",
          sampleRateHertz: 48000,
          useEnhanced: false,
          enableAutomaticPunctuation: false,
          languageCode: lan,
          enableWordTimeOffsets: false,
        },
        audio: {
          content: await e,
        },
      })
      .then((response) => {
        return response.data;
      })
      .catch((error) => {
        console.error(`Error al enviar el segmento ${index}:`, error);
        throw error;
      });
  });
  // Esperar a que todos los segmentos se procesen y devolver los resultados
  return Promise.all(promises);
};

// Función para dividir un texto base64 de audio en segmentos y enviarlos a la API
const splitAndSendSegmentsWithModel = async (base64Text, key, lan) => {
  const segmentSize = 1024 * 1024; // 1MB
  const totalSegments = Math.ceil(base64Text.length / segmentSize);
  const segmentsArray = [];
  // Dividir el texto base64 en segmentos
  for (let i = 0; i < totalSegments; i++) {
    const start = i * segmentSize;
    const end = Math.min(start + segmentSize, base64Text.length);
    const segment = base64Text.substring(start, end);
    segmentsArray.push(segment);
  }

  // Mapear cada segmento a una Promesa para enviarlo a la API
  const promises = splitBase64Text(base64Text).map(async (e, index) => {
    const endpoint = `https://speech.googleapis.com/v1/speech:recognize?key=${key}`;
    return await axios
      .post(endpoint, {
        config: {
          model: "latest_long",
          encoding: "MP3",
          sampleRateHertz: 48000,
          useEnhanced: true,
          enableAutomaticPunctuation: true,
          languageCode: lan,
          enableWordTimeOffsets: true,
        },
        audio: {
          content: await e,
        },
      })
      .then((response) => {
        return response.data;
      })
      .catch((error) => {
        console.error(`Error al enviar el segmento ${index}:`, error);
        throw error;
      });
  });
  // Esperar a que todos los segmentos se procesen y devolver los resultados
  return Promise.all(promises);
};

export const transcibedAudio = async (audioFile) => {
  const apiKey = "AIzaSyA17EgR12viKVmi00ZjTWL0HYVP_pZpZyc";
  let sizeFile = bytesToMegabytes(audioFile.audio[0].size);
  let transcriptText = "";
  let transcriptTextWithModel = "";

  // Verificar si el tamaño del archivo es mayor que 1MB
  if (sizeFile > 1) {
    // Convertir el blob de audio a base64 usando la funcion audioBlobToBase64
    const base64Audio = await audioBlobToBase64(audioFile.audio[0]);
    // Dividir el audio base64 en segmentos y enviarlos a la API
    const response = await splitAndSendSegments(
      base64Audio,
      apiKey,
      audioFile.language
    )
      .then((results) => {
        // Procesar los resultados y concatenar las transcripciones
        results.forEach((e) => {
          if (e.results && e.results.length >= 0) {
            for (let i = 0; i < e.results.length; i++) {
              transcriptText += e.results[i].alternatives[0].transcript;
            }
          }
        });

        return transcriptText;
      })
      .catch((error) => {
        console.error("Ocurrió un error al enviar los segmentos:", error);
      });

    const responseWithModel = await splitAndSendSegmentsWithModel(
      base64Audio,
      apiKey,
      audioFile.language
    )
      .then((results) => {
        // Procesar los resultados y concatenar las transcripciones
        results.forEach((e) => {
          if (e.results && e.results.length >= 0) {
            for (let i = 0; i < e.results.length; i++) {
              transcriptTextWithModel +=
                e.results[i].alternatives[0].transcript;
            }
          }
        });

        return transcriptTextWithModel;
      })
      .catch((error) => {
        console.error("Ocurrió un error al enviar los segmentos:", error);
      });

    return [
      { model: "con Google Speech To Text", text: transcriptText },
      {
        model: "con Whisper IA",
        text: transcriptTextWithModel,
      },
      {
        model: "de humano",
        text: referencia
      }
    ];

    // return [transcriptText, ]
  } else {
    // Si el tamaño del archivo es menor o igual a 1MB, enviar el archivo de audio completo de una vez
    const base64Audio = await audioBlobToBase64(audioFile.audio[0]);

    const endpoint = `https://speech.googleapis.com/v1/speech:recognize?key=${apiKey}`;
    const responseWithModel = await axios.post(endpoint, {
      config: {
        model: "latest_short",
        encoding: "MP3",
        sampleRateHertz: 48000,
        useEnhanced: true,
        enableAutomaticPunctuation: true,
        languageCode: audioFile.language,
        enableWordTimeOffsets: true,
      },
      audio: {
        content: base64Audio,
      },
    });
    // Obtener la transcripción de la respuesta de la API
    if (
      responseWithModel.data?.results &&
      responseWithModel.data.results.length > 0
    ) {
      transcriptTextWithModel =
        responseWithModel.data.results[0].alternatives[0].transcript;
    } else {
      transcriptTextWithModel =
        "No se pudo obtener la transcripción. Intenta mas tarde";
    }

    const response = await axios.post(endpoint, {
      config: {
        encoding: "MP3",
        sampleRateHertz: 48000,
        useEnhanced: true,
        enableAutomaticPunctuation: true,
        languageCode: audioFile.language,
        enableWordTimeOffsets: true,
      },
      audio: {
        content: base64Audio,
      },
    });
    // Obtener la transcripción de la respuesta de la API
    if (response.data?.results && response.data.results.length > 0) {
      transcriptText = response.data.results[0].alternatives[0].transcript;
    } else {
      transcriptText = "No se pudo obtener la transcripción. Intenta mas tarde";
    }
  }

  // Devolver la transcripción

  return [
    { model: "default", text: transcriptText },
    {
      model: "Whisper AI",
      text: transcriptTextWithModel,
    },
    {
      model: "de humano",
      text: referencia
    }
  ];

  // return [transcriptText, transcriptTextWithModel];
};

export default transcibedAudio;
